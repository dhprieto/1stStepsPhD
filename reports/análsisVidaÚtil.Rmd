---
title: "análisisVidaÚtil"
output:
  html_document:
    df_print: paged
  pdf_document:
    latex_engine: xelatex
---

```{r librerias, echo=FALSE}
library("ggplot2")
library("gridExtra")

```
# Trabajo con los datos de Vicente

## Compuestos fenólicos (Procesado?)

Primero, se mide el efecto de agregar un endulzante determinado al zumo y se van haciendo medidas de metabolitos en diferentes tiempos y condiciones.Tenemos entonces dos factores que determinan el valor de los mg/100 ml de zumo, que serían las condiciones de toma de la muestra y el tipo de endulzante que se está añadiendo.  

Medimos cuatro compuestos: 

* Derivados del Naringenin hexosido
- Eriodictiol hexosa
- Naringenin rutinosido 
- Hespertin rutinosido.

En primer lugar se extrae el área del cromatógrafo y se transforma en mg/100 ml de zumo, con la fórmula siguiente:

$$((AREA-221,08)/18129)*610,19*(0,1)$$

Se repite la medición cada 15 días, en condiciones de luz y oscuridad, a 5º y a 25º celsius de temperatura.

El procesado estadístico realizado en el excel adjuntado consiste en hacer la media y la desviación estándar de cada repetición hecha en las mismas condiciones. Después se calculan los mg totales de compuestos detectados por cada repetición, se hace la media y la SD, además de un porcentaje de pérdida respecto a la primera medida. Se replica en R (faltan los totales y la pérdida)

## Procesado y ordenamiento:

```{r Procesado, echo=TRUE}

# Funcion de procesado de tablas

procesado <- function(tabla, endulzante){
  
  tabla_num <- tabla[-1]
  
  # Se obtienen las medias de cada medida
  
  tabla_mean <- do.call(rbind, 
                        lapply(seq(1, nrow(tabla_num), 2), function(i){
                          x <- tabla_num[ i:(i + 1), , drop = FALSE]
                          res <- rbind(colSums(x)/2)
                          res
                        }))
  
  rownames(tabla_mean) <- unique(tabla$Condiciones)
  
  # La desviación estándar
  
  tabla_sd <- do.call(rbind, 
                      lapply(seq(1, nrow(tabla_num), 2), function(i){
                        x <- tabla_num[ i:(i + 1), , drop = FALSE]
                        res <- rbind(apply(x, 2, sd))
                        res
                      }))
  
  # Apilamos datos
  
  tabla_1 <- stack(as.data.frame(tabla_mean))
  tabla_1$Condiciones <- rep(unique(tabla$Condiciones),4)
  
  tabla_2 <- stack(as.data.frame(tabla_sd))
  tabla_2$Condiciones <- rep(unique(tabla$Condiciones),4)
  
  tabla_total <- merge(tabla_1, tabla_2, by = c("Condiciones", "ind"))
  
  tabla_total$Endulzante <- rep(endulzante, nrow(tabla_total))
  
  dplyr::rename(tabla_total, mean = values.x , SD = values.y, Compuesto = ind)
  
}

# ---- Lectura y procesado de las tablas

fenSU <- read.csv("data/Compuestos fenolicos SU VidaUtil Cronico_1.csv", sep = ";", dec = ",")
fenSA <- read.csv("data/Compuestos fenolicos SA VidaUtil Cronico_1.csv", sep = ";", dec = ",")
fenST <- read.csv("data/Compuestos fenolicos ST VidaUtil Cronico_1.csv", sep = ";", dec = ",")


fenSU_total <- procesado(fenSU, "SU")
fenSA_total <- procesado(fenSA, "SA")
fenST_total <- procesado(fenST, "ST")

fenFlavTotal <- rbind(fenSU_total, fenSA_total, fenST_total)

# Separamos las condiciones

fenFlavTotal$Iluminacion <- rep(x = "Luz", nrow(fenFlavTotal))
fenFlavTotal$Dia<- rep(x = "0", nrow(fenFlavTotal))
fenFlavTotal$Temperatura <- rep(x = "25º", nrow(fenFlavTotal))

for (i in seq(1,nrow(fenFlavTotal))){
    if (grepl(pattern = "\\s5º", x = fenFlavTotal$Condiciones[i])){
      fenFlavTotal$Temperatura[i] <- "5º"
    
    }
    
    else if (grepl(pattern = "Osc", x = fenFlavTotal$Condiciones[i])){
      fenFlavTotal$Iluminacion[i] <- "Osc"  
    }
    
    else if (grepl(pattern = "15", x = fenFlavTotal$Condiciones[i])){
      fenFlavTotal$Dia[i] <- "15"  
      
    }

    else if (grepl(pattern = "30", x = fenFlavTotal$Condiciones[i])){
      fenFlavTotal$Dia[i] <- "30"  
    
    }
  
    else if (grepl(pattern = "45", x = fenFlavTotal$Condiciones[i])){
      fenFlavTotal$Dia[i] <- "45"  
    
    }
    
    else if (grepl(pattern = "60", x = fenFlavTotal$Condiciones[i])){
      fenFlavTotal$Dia[i] <- "60"  
    
      
    }
    else if (grepl(pattern = "90", x = fenFlavTotal$Condiciones[i])){
      fenFlavTotal$Dia[i] <- "90"  
    }
}

skimr::skim(fenFlavTotal)


```








## Pruebas adicionales

#### Normalidad

``` {r normalidad, echo = TRUE }


shapiro.test(fenFlavTotal$mean)

par(mfrow = c(2,2))
qqnorm(fenFlavTotal[fenFlavTotal$Endulzante == "SA","mean"], main = "SA")
qqline(fenFlavTotal[fenFlavTotal$Endulzante == "SA","mean"])
qqnorm(fenFlavTotal[fenFlavTotal$Endulzante == "ST","mean"], main =  "ST")
qqline(fenFlavTotal[fenFlavTotal$Endulzante == "ST","mean"])
qqnorm(fenFlavTotal[fenFlavTotal$Endulzante == "SA","mean"], main = "SU")
qqline(fenFlavTotal[fenFlavTotal$Endulzante == "SU","mean"])



```

La media de las medidas no presenta una distribución normal.

### Homocedasticidad

``` {r homocedasticidad, echo = TRUE }

var.test(x = fenFlavTotal[fenFlavTotal$Endulzante == "SA", "mean"],
         y = fenFlavTotal[fenFlavTotal$Endulzante == "SU", "mean"] )

var.test(x = fenFlavTotal[fenFlavTotal$Endulzante == "SA", "mean"],
         y = fenFlavTotal[fenFlavTotal$Endulzante == "ST", "mean"] )

var.test(x = fenFlavTotal[fenFlavTotal$Endulzante == "ST", "mean"],
         y = fenFlavTotal[fenFlavTotal$Endulzante == "SU", "mean"] )

#### Box-plot

```{r box-plot, echo=TRUE}


ggplot(data = as.data.frame(fenFlavTotal), aes(x = Endulzante, y = mean, color = Endulzante)) +
  geom_boxplot() +
  theme_bw()

p1 <- ggplot(data = as.data.frame(fenFlavTotal), aes(x = Endulzante, y = mean)) + 
  geom_boxplot() + theme_bw()
p2 <- ggplot(data = as.data.frame(fenFlavTotal), aes(x = Condiciones, y = mean)) +
  geom_boxplot() + theme_bw()
p3 <- ggplot(data = as.data.frame(fenFlavTotal), aes(x = Endulzante, y = mean, colour = Condiciones)) +
  geom_boxplot() + theme_bw()

grid.arrange(p1, p2, ncol = 2)
p3

```


Se cumple la condición de homogeneidad de varianzas. 

### 2WAY-ANOVA

Dado que comparamos dos variables independientes cualitativas y una variable
dependiente cuantitativa, la condición de normalidad no se cumple pero existe
cierto margen al aproximarse la distribución de la variable dependiente a la 
normal. Por tanto, realizaremos el estudio con el test paramétrico:

```{r 2way-ANOVA, echo=TRUE}
# Con interacción entre factores

anova <- aov(mean ~ Compuesto * Endulzante, data = fenFlavTotal)
summary(anova)
par(mfrow=c(1,2))
plot(anova, which=1:4)
par(mfrow = c(1,1))
lsr::etaSquared(anova)

# Sin interacción entre factores

anova2 <- aov(mean ~ Compuesto + Endulzante, data = fenFlavTotal)
summary(anova2)
par(mfrow=c(1,2))
plot(anova2, which=1:4)
par(mfrow = c(1,1))
lsr::etaSquared(anova2)


```

Se observa que se cumplen las condiciones para la ANOVA, y que existe un efecto
significativo sobre la media de la medida por parte del compuesto y del 
endulzante, así como del efecto de la interacción de ambos factores. Vemos que
el efecto es mucho más fuerte en el compuesto que en el endulzante


## Muestras bio

### Cronico Orina Atipicos

### Cronico plasma Atipicos


